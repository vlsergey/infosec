<!DOCTYPE html SYSTEM "about:legacy-compat">
<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><style type="text/css"> 
div.toc-item-h2 {
  padding-left: 2em;
}
div.toc-item-h3 {
  padding-left: 4em;
}
div.toc-item-h4 {
  padding-left: 6em;
}
div.toc-item-h5 {
  padding-left: 8em;
}
div.toc-item-h6 {
  padding-left: 10em;
}
</style><link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" rel="stylesheet"><style type="text/css"> 
span.small {
  font-size: 90%
}
span.tiny {
  font-size: 50%
}
</style><style type="text/css"> 
div.mathjax {
  padding-top: .5em;
  padding-bottom: .5em;
}
</style></head><body><div class="container"><h2 data-command-name="section" id="13_4_Защита_IPsec_на_сетевом_уровне">13.4. Защита IPsec на сетевом уровне</h2><p><a name="N107396"><!--протокол!IPsec|(--></a>
Набор протоколов IPsec (англ. <span lang="en"><i>Internet Protocol Security</i></span>)<span class="nonbreaking-interword-space"> </span><a href="Literatura.html#rfc4301">[54]</a> является неотъемлемой частью IPv6<a name="N107420"><!--протокол!IPv6--></a> и дополнительным необязательным расширением IPv4. IPsec обеспечивает защиту данных на сетевом уровне IP-пакетов.</p><p>IPsec определяет:</p><ul><li>первичную аутентификацию сторон и управление сеансовыми ключами (протокол IKE, англ. <span lang="en"><i>Internet Key Exchange</i></span>);<a name="N107442"><!--протокол!IKE--></a></li><li>шифрование с аутентификацией (протокол ESP, англ. <span lang="en"><i>Encapsulating Security Payload</i></span>);<a name="N107462"><!--протокол!ESP--></a></li><li>только аутентификацию сообщений (протокол AH, англ. <span lang="en"><i>Authentication Header</i></span>).<a name="N107482"><!--протокол!AH--></a></li></ul><p>Основное (современное) применение этих протоколов состоит в построении VPN<a name="N107488"><!--протокол!VPN--></a> (Virtual Private Network &ndash; виртуальная частная сеть) при использовании IPsec в так называемом туннельном режиме.</p><p>Аутентификация в режимах ESP и AH определяется по-разному. Аутентификация в ESP гарантирует целостность<a name="N107494"><!--целостность--></a> только зашифрованных полезных данных (пакетов следующего уровня после IP). Аутентификация AH гарантирует целостность всего IP-пакета (за исключением полей, изменяемых в процессе передачи пакета по сети).</p><h3 data-command-name="subsection" id="13_4_1_Протокол_создания_ключей_IKE">13.4.1. Протокол создания ключей IKE</h3><!--%http://www.ietf.org/rfc/rfc4306.txt--><p>Протокол IKE версии 2 (англ. <span lang="en"><i>Internet Key Exchange</i></span>)<a name="N107526"><!--протокол!IKE--></a><span class="nonbreaking-interword-space"> </span><a href="Literatura.html#rfc4306">[53]</a>, по существу, можно описать следующим образом. Пусть <span class="mathjax">$I$</span> &ndash; инициатор соединения, <span class="mathjax">$R$</span> &ndash; отвечающая сторона.</p><p>Протокол состоит из двух фаз. Первая фаза очень похожа на установление соединения в SSL/TLS: она включает возможный обмен сертификатами <span class="mathjax">$C_I, C_R$</span> стандарта X.509 для аутентификации (или альтернативную аутентификацию по общему заранее созданному секретному ключу) и создание общих предварительных сеансовых ключей протокола IKE по протоколу Диффи<span class="nonbreaking-interword-space"> </span>&mdash;<span class="nonbreaking-interword-space"> </span>Хеллмана<a name="N107549"><!--протокол!Диффи—Хеллмана--></a>. Сеансовые ключи протокола IKE служат для шифрования и аутентификации сообщений второй фазы. Вторая фаза создаёт сеансовые ключи для протоколов ESP, AH, то есть ключи для шифрования конечных данных. Сообщения второй фазы также используются для смены ранее созданных сеансовых ключей, и в этом случае протокол сразу начинается со второй фазы с применением ранее созданных сеансовых ключей протокола IKE.</p><ol><li>Создание предварительной защищённой связи для протокола IKE и аутентификация сторон.
        <ol><li><span class="mathjax">$I \rightarrow R$</span>: <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$\left(g^{x_I}\right.$</span>, одноразовая метка <span class="mathjax">$N_I$</span>, идентификаторы поддерживаемых криптографических алгоритмов<span class="mathjax">$\left.\right)$</span>.
                <!--% HDR, SAi1, KEi, Ni   - ->--></li><li><span class="mathjax">$I \leftarrow R$</span>: <span class="nonbreaking-interword-space"> </span><span class="mathjax">$\left(g^{x_R}\right.$</span>, одноразовая метка <span class="mathjax">$N_R$</span>, идентификаторы выбранных алгоритмов, запрос сертификата <span class="mathjax">$C_I\left.\right)$</span>.
                <!--% <- -    HDR, SAr1, KEr, Nr, [CERTREQ]-->
                Протокол Диффи<span class="nonbreaking-interword-space"> </span>&mdash;<span class="nonbreaking-interword-space"> </span>Хеллмана<a name="N107599"><!--протокол!Диффи—Хеллмана--></a> оперирует с генератором <span class="mathjax">$g=2$</span> в группе <span class="mathjax">${{\mathbb{Z}}}_p^*$</span> для одного из двух фиксированных <span class="mathjax">$p$</span> длиной 768 или 1024 бита. После обмена элементами <span class="mathjax">$g^{x_I}$</span> и <span class="mathjax">$g^{x_R}$</span> обе стороны обладают общим секретом <span class="mathjax">$g^{x_I x_R}$</span>.

                Одноразовые метки <span class="mathjax">$N_I, N_R$</span> созданы криптографическим генератором псевдослучайных чисел <span class="mathjax">$PRF$</span>.

                После данного сообщения стороны договорились об используемых алгоритмах и создали общие сеансовые ключи:
                    <div class="mathjax" style="text-align: center;">$$ seed = PRF(N_i ~\|~ N_r, ~g^{x_I x_R}), $$</div>
                    <div class="mathjax" style="text-align: center;">$$ \{ K_d \| Ka_I \| Ka_R \| Ke_I \| Ke_R
                                                \} = PRF(seed, ~ N_i ~\|~ N_r), $$</div>
                где <span class="mathjax">$Ka_I, Ka_R$</span> &ndash; ключи кода аутентификации для связи в обоих направлениях, <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$Ke_I, Ke_R$</span> &ndash; ключи шифрования сообщений для двух направлений, <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$K_d$</span> &ndash; инициирующее значение генератора <span class="mathjax">$PRF$</span> для создания сеансовых ключей окончательной защищённой связи, <span class="nonbreaking-interword-space"> </span> функцией <span class="mathjax">$PRF(x)$</span> обозначается выход генератора с инициализирующим значением <span class="mathjax">$x$</span>.
                <!--%$Kp_I, Kp_R$ - -  which areused when generating an AUTH payload.-->
                При дальнейшем обмене данными сообщения шифруются алгоритмом AES<a name="N107667"><!--шифр!AES--></a> в режиме CBC со случайно выбранным инициализирующим вектором <span class="mathjax">$IV$</span> на сеансовых ключах <span class="mathjax">$Ke$</span> и аутентифицируются имитовставкой<a name="N107679"><!--имитовставка--></a> на ключах <span class="mathjax">$Ka$</span>. Введём обозначения для шифрования сообщения <span class="mathjax">$m$</span> со сцеплением блоков <span class="mathjax">$E_{Ke_X}(m)$</span>, и совместного шифрования, и добавления кода аутентификации сообщений <span class="mathjax">$\langle m \rangle_X$</span> для исходящих данных от стороны <span class="mathjax">$X$</span>:
                    <div class="mathjax" style="text-align: center;">$$  E_{Ke_X}(m) = IV ~\|~ E_{Ke_X}(IV ~\|~ m), $$</div>
                    <div class="mathjax" style="text-align: center;">$$  \langle m \rangle_X = E_{Ke_X}(m) ~\|~ {\textrm{HMAC}}(Ka_X, ~ E_{Ke_X}(m)). $$</div></li><li><span class="mathjax">$I \rightarrow R$</span>: <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$\langle ID_I, ~ C_I, ~\text{запрос сертификата}~ C_R, ~ ID_R, ~ A_I \rangle_I$</span>.
                <!--% HDR, SK {IDi, [CERT,] [CERTREQ,] [IDr,] AUTH, SAi2, TSi, TSr}     - ->-->
                По значениям идентификаторов <span class="mathjax">$ID_I, ID_R$</span> сторона <span class="mathjax">$R$</span> проверяет знание стороной <span class="mathjax">$I$</span> ключей <span class="mathjax">$Ke, Ka$</span>.

                Поле <span class="mathjax">$A_I$</span> обеспечивает аутентификацию стороны <span class="mathjax">$I$</span> стороне <span class="mathjax">$R$</span> одним из двух способов. Если используются сертификаты, то <span class="mathjax">$I$</span> показывает, что обладает закрытым ключом, парным открытому ключу сертификата <span class="mathjax">$C_I$</span>, подписывая сообщение <span class="mathjax">$\textrm{data}$</span>:
                    <div class="mathjax" style="text-align: center;">$$ A_I = \textrm{ЭП}(\textrm{data}). $$</div>
                Сторона <span class="mathjax">$R$</span> также проверяет сертификат <span class="mathjax">$C_I$</span> по цепочке до доверенного сертификата верхнего уровня.

                Второй вариант аутентификации &ndash; по общему секретному симметричному ключу аутентификации <span class="mathjax">$K_{IR}$</span>, который заранее был создан <span class="mathjax">$I$</span> и <span class="mathjax">$R$</span>, как в Kerberos. Сторона <span class="mathjax">$I$</span> показывает, что знает общий секрет, вычисляя
                    <div class="mathjax" style="text-align: center;">$$ A_I = \textrm{PRF}( \textrm{PRF}(K_{IR}, ~ \text{текст ''Key Pad for IKEv2''}), \textrm{data}). $$</div>
                Сторона <span class="mathjax">$R$</span> сравнивает присланное значение <span class="mathjax">$A_I$</span> с вычисленным и убеждается, что <span class="mathjax">$I$</span> знает общий секрет.

                Сообщение <span class="mathjax">$data$</span> &ndash; это открытое сообщение данной транзакции, за исключением нескольких полей.</li><li><span class="mathjax">$I \leftarrow R$</span>: <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$\langle ID_R, ~ C_R, ~ A_R \rangle_R$</span>.
                <!--% HDR, SK {IDr, [CERT,] AUTH, SAr2, TSi, TSr}-->
                Производится аутентификация стороны <span class="mathjax">$R$</span> стороной <span class="mathjax">$I$</span> аналогичным образом.</li></ol></li><li>Создание защищённой связи для протоколов ESP, AH, то есть ключей шифрования и кодов аутентификации конечных полезных данных. Фаза повторяет первые две транзакции первой фазы с созданием ключей по одноразовой метке <span class="mathjax">$N'$</span> и протоколу Диффи<span class="nonbreaking-interword-space"> </span>&mdash;<span class="nonbreaking-interword-space"> </span>Хеллмана<a name="N107808"><!--протокол!Диффи—Хеллмана--></a> с закрытыми ключами <span class="mathjax">$x'$</span>.
        <ol><li><span class="mathjax">$I \rightarrow R$</span>: <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$\langle g^{x'_I}$</span>, одноразовая метка <span class="mathjax">$N'_I$</span>, поддерживаемые алгоритмы для ESP, AH<span class="mathjax">$\rangle_I$</span>.
                <!--% HDR, SK {[N], SA, Ni, [KEi], [TSi, TSr]}             - ->--></li><li><span class="mathjax">$I \rightarrow R$</span>: <span class="nonbreaking-interword-space"> </span> <span class="mathjax">$\langle g^{x'_R}$</span>, одноразовая метка <span class="mathjax">$N'_R$</span>, выбранные алгоритмы для ESP, AH<span class="mathjax">$\rangle_R$</span>.
                <!--% <- -    HDR, SK {SA, Nr, [KEr], [TSi, TSr]}--></li></ol>
        По окончании второй фазы обе стороны имеют общие секретные ключи <span class="mathjax">$Ke, Ka$</span> для шифрования и коды аутентификации в двух направлениях, от стороны <span class="mathjax">$I$</span> и от стороны <span class="mathjax">$R$</span>:
            <div class="mathjax" style="text-align: center;">$$ \{Ka'_I ~\|~ Ka'_R ~\|~ Ke'_I ~\|~ Ke'_R \} = PRF(K_d, ~ g^{x'_I x'_R} ~\|~ N'_I ~\|~ N'_r). $$</div></li></ol><p>Итогом работы протокола IKE является набор сеансовых ключей для шифрования <span class="mathjax">$Ke'_I, ~ Ke'_R$</span> и кодов аутентификации <span class="mathjax">$Ka'_I, ~ Ka'_R$</span> в протоколах ESP и AH.</p><h3 data-command-name="subsection" id="13_4_2_Таблица_защищённых_связей">13.4.2. Таблица защищённых связей</h3><p><em>Защищённая связь</em> (англ. <span lang="en"><i>Security Association, SA</i></span>) является <em>однонаправленной</em> от отправителя к получателю и характеризуется тремя основными параметрами:</p><ul><li>индексом параметров защиты &ndash; уникальным 32-битовым числом, входящим в заголовок ESP- и AH-пакетов;</li><li>IP-адресом стороны-отправителя;</li><li>идентификатором применения ESP- или AH-протокола.</li></ul><p>Защищённые связи хранятся в таблице защищённых связей со следующими полями:</p><ul><li>счётчик порядкового номера, входит в заголовок ESP- и AH-пакетов;</li><li>окно защиты от воспроизведения &ndash; скользящий буфер порядковых номеров пакетов для защиты от пропуска и повтора пакетов;</li><li>информация протокола ESP и AH &ndash; алгоритмы, ключи, время действия ключей;</li><li>режим протокола: транспортный или туннельный.</li></ul><p>По индексу параметров защиты, находящемуся в заголовке ESP- и AH-пакетов, получатель из таблицы защищённых связей извлекает параметры (названия алгоритмов, ключи и<span class="nonbreaking-interword-space"> </span>т.&nbsp;д.), производит проверки счётчиков, аутентифицирует и расшифровывает вложенные данные для принятого IP-пакета.</p><!--%Или создаёт зашифрованный аутентифицированный IP-пакет, который включает индекс параметров защиты, чтобы получатель мог из своей таблицы защищённых связей извлечь ключи для аутентификации и расшифрования.--><p>Протоколы ESP и AH можно применять к IP-пакету в трёх вариантах:</p><ul><li>только ESP-протокол;</li><li>только AH-протокол;</li><li>последовательное применение ESP- и AH-протоколов.</li></ul><p>Подчеркнём, что только AH-протокол гарантирует целостность<a name="N107941"><!--целостность--></a> всего IP-пакета, поэтому для организации виртуальной сети VPN<a name="N107947"><!--сеть!виртуальная частная--></a>, как правило, применяется третий вариант (последовательно ESP- и AH-протоколы).</p><h3 data-command-name="subsection" id="13_4_3_Транспортный_и_туннельный_режимы">13.4.3. Транспортный и туннельный режимы</h3><p>Протоколы ESP, AH могут применяться в транспортном режиме, когда исходный IP-пакет расширяется заголовками и концевиками протоколов ESP, AH, или в туннельном режиме, когда весь IP-пакет вкладывается в новый IP-пакет, который включает заголовки и концевики ESP, AH.</p><p>Новый IP-пакет в туннельном режиме может иметь другие IP-адреса, отличные от оригинальных. Именно это свойство используется для построения виртуальных частных сетей (англ. <span lang="en"><i>Virtual Private Network, VPN</i></span>)<a name="N107977"><!--сеть!виртуальная частная--></a>. IP-адресом нового пакета является IP-адрес IPsec-шлюза виртуальной сети. IP-адрес вложенного пакета является локальным адресом виртуальной сети. IPsec-шлюз производит преобразование IPsec-пакетов в обычные IP-пакеты виртуальной сети и наоборот.</p><p>Схемы транспортного и туннельного режимов показаны ниже отдельно для ESP- и AH-протоколов.</p><h3 data-command-name="subsection" id="13_4_4_Протокол_шифрования_и_аутентификации_ESP">13.4.4. Протокол шифрования и аутентификации ESP</h3><p>Протокол ESP<a name="N107994"><!--протокол!ESP--></a> определяет шифрование и аутентификацию вложенных в IP-пакет сообщений в формате, показанном на рис.<span class="nonbreaking-interword-space"> </span><a href="13_4_Zaschita_IPsec_na_setevom_urovne.html#fig:ipsec-esp">13.3</a>.</p><figure style="margin-left: auto; margin-right: auto; display: flex; flex-wrap: wrap; align-items: baseline; justify-content: center; width: fit-content; height: fit-content; width: 90%;"><a name="fig:ipsec-esp" style="vertical-align: top; align-self: start;"></a><img src="images/5DDD1C0FDB9DA9652809D298D5A27C4F.png" style="width: 100%"><figcaption style="flex-basis: 100%; text-align: center;">Рис. 13.3 &mdash; Формат ESP-пакета</figcaption></figure><p>Шифрование вложенных данных производится в режиме CBC алгоритмом AES на ключе <span class="mathjax">$Ke'$</span> с псевдослучайным вектором инициализации IV, вставленным перед зашифрованными данными.</p><p>Аутентификатор сообщения определяется как усечённое до 96 бит значение <span class="mathjax">${\textrm{HMAC}}(Ka', m)$</span>, вычисленное стандартным способом.</p><p>На рис.<span class="nonbreaking-interword-space"> </span><a href="13_4_Zaschita_IPsec_na_setevom_urovne.html#fig:ipsec-esp-modes">13.4</a> показано применение протокола в транспортном и туннельном режимах.</p><figure style="margin-left: auto; margin-right: auto; display: flex; flex-wrap: wrap; align-items: baseline; justify-content: center; width: fit-content; height: fit-content; width: 90%;"><a name="fig:ipsec-esp-modes" style="vertical-align: top; align-self: start;"></a><img src="images/401F8FB39659E73C16CAEA7A0AB4699B.png" style="width: 100%"><figcaption style="flex-basis: 100%; text-align: center;">Рис. 13.4 &mdash; Применение ESP протокола к пакету IPv6</figcaption></figure><h3 data-command-name="subsection" id="13_4_5_Протокол_аутентификации_AH">13.4.5. Протокол аутентификации AH</h3><p>Протокол AH определяет аутентификацию всего IP-пакета в формате, показанном на рис.<span class="nonbreaking-interword-space"> </span><a href="13_4_Zaschita_IPsec_na_setevom_urovne.html#fig:ipsec-ah">13.5</a>.</p><figure style="margin-left: auto; margin-right: auto; display: flex; flex-wrap: wrap; align-items: baseline; justify-content: center; width: fit-content; height: fit-content; width: 70%;"><a name="fig:ipsec-ah" style="vertical-align: top; align-self: start;"></a><img src="images/437F4014DFE779EFE147FCDAE342101E.png" style="width: 100%"><figcaption style="flex-basis: 100%; text-align: center;">Рис. 13.5 &mdash; Заголовок AH пакета</figcaption></figure><p>Аутентификатор сообщения определяется так же, как и в протоколе ESP &ndash; усечённое до 96 бит значение <span class="mathjax">${\textrm{HMAC}}(Ka', m)$</span>, вычисленное стандартным способом.</p><p>На рис.<span class="nonbreaking-interword-space"> </span><a href="13_4_Zaschita_IPsec_na_setevom_urovne.html#fig:ipsec-ah-modes">13.6</a> показано применение протокола в транспортном и туннельном режимах.</p><figure style="margin-left: auto; margin-right: auto; display: flex; flex-wrap: wrap; align-items: baseline; justify-content: center; width: fit-content; height: fit-content; width: 90%;"><a name="fig:ipsec-ah-modes" style="vertical-align: top; align-self: start;"></a><img src="images/AF57FC5638652CAA087166D4E9B2651A.png" style="width: 100%"><figcaption style="flex-basis: 100%; text-align: center;">Рис. 13.6 &mdash; Применение протокола AH к пакету IPv6</figcaption></figure><p><a name="N108164"><!--протокол!IPsec|)--></a></p><nav aria-label="Page navigation example"><ul class="pagination justify-content-center"><li class="page-item"><a class="page-link" href="13_3_Protokol_SSL_TLS.html">&#129080; 13_3_Protokol_SSL_TLS</a></li><li class="page-item"><a class="page-link" href="13_5_Zaschita_informatsii_.html">13_5_Zaschita_informatsii_ &#129082;</a></li></ul></nav></div><script>
window.MathJax = {
  loader: {
    load: ['[tex]/tagformat'],
  },
  options: {
    processHtmlClass: 'mathjax'
  },
  tex: {
    packages: {
      '[+]': ['base', 'ams', 'physics', 'textcomp']
    },
    inlineMath: [['$', '$']],
  },
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async="yes" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></body></html>