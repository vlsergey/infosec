<!DOCTYPE html SYSTEM "about:legacy-compat">
<html><head><META http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><style type="text/css"> 
div.toc-item-h2 {
  padding-left: 2em;
}
div.toc-item-h3 {
  padding-left: 4em;
}
div.toc-item-h4 {
  padding-left: 6em;
}
div.toc-item-h5 {
  padding-left: 8em;
}
div.toc-item-h6 {
  padding-left: 10em;
}
</style><link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" rel="stylesheet"><style type="text/css"> 
span.small {
  font-size: 90%
}
span.tiny {
  font-size: 50%
}
</style><style type="text/css"> 
div.mathjax {
  padding-top: .5em;
  padding-bottom: .5em;
}
</style></head><body><div class="container"><h2 data-command-name="section" id="13_3_Протокол_SSL_TLS">13.3. Протокол SSL/TLS</h2><p><a name="N106851"><!--протокол!SSL/TLS--></a>
Протокол SSL (англ. <span lang="en"><i>Secure Sockets Layer</i></span>) был разработан компанией Netscape. Начиная с версии 3, протокол развивается как открытый стандарт TLS (англ. <span lang="en"><i>Transport Layer Security</i></span>). Протокол SSL/TLS обеспечивает защищённое соединение по незащищённому каналу связи на прикладном уровне модели TCP/IP. Протокол встраивается между прикладным и транспортным уровнями стека протоколов TCP/IP. Для обозначения &laquo;новых&raquo; протоколов, полученных с помощью инкапсуляции прикладного уровня (HTTP<a name="N106883"><!--протокол!HTTP--></a>, FTP<a name="N106889"><!--протокол!FTP--></a>, SMTP<a name="N106895"><!--протокол!SMTP--></a>, POP3<a name="N106901"><!--протокол!POP3--></a>, IMAP<a name="N106907"><!--протокол!IMAP--></a> и<span class="nonbreaking-interword-space"> </span>т.&nbsp;д.) в SSL/TLS, к обозначению добавляют суффикс &laquo;S&raquo; (&laquo;Secure&raquo;): HTTPS<a name="N106917"><!--протокол!HTTPS--></a>, FTPS<a name="N106923"><!--протокол!FTPS--></a>, POP3S<a name="N106929"><!--протокол!POP3S--></a>, IMAPS<a name="N106935"><!--протокол!IMAPS--></a> и<span class="nonbreaking-interword-space"> </span>т.&nbsp;д.</p><p>Протокол обеспечивает следующее:</p><ul><li>Одностороннюю или взаимную аутентификацию клиента и сервера по открытым ключам сертификата X.509. В Интернете, как правило, делается <em>односторонняя</em> аутентификация веб-сервера браузеру клиента, то есть только веб-сервер предъявляет сертификат (открытый ключ и ЭП к нему от вышележащего УЦ).</li><li>Создание сеансовых симметричных ключей для шифрования и кода аутентификации сообщения для передачи данных в обе стороны.</li><li>Конфиденциальность<a name="N106958"><!--конфиденциальность--></a> &ndash; блочное или потоковое шифрование передаваемых данных в обе стороны.</li><li>Целостность<a name="N106966"><!--целостность--></a> &ndash; аутентификацию отправляемых сообщений в обе стороны имитовставкой<a name="N106972"><!--имитовставка--></a> <span class="mathjax">${\textrm{HMAC}}(K,M)$</span>, описанной ранее.</li></ul><p>Рассмотрим протокол TLS последней версии 1.2.</p><h3 data-command-name="subsection" id="13_3_1_Протокол_рукопожатия_">13.3.1. Протокол &laquo;рукопожатия&raquo;</h3><p>Протокол &laquo;рукопожатия&raquo; (англ. <span lang="en"><i>Handshake Protocol</i></span>) производит аутентификацию и создание сеансовых ключей между клиентом <span class="mathjax">$C$</span> и сервером <span class="mathjax">$S$</span>.</p><ol><li><span class="mathjax">$C \rightarrow S$</span>:
        <ol><li>ClientHello: <span class="nonbreaking-interword-space"> </span> 1) URI сервера, <span class="nonbreaking-interword-space"> </span> 2) одноразовая метка <span class="mathjax">$N_C$</span><a name="N107026"><!--одноразовая метка--></a>, <span class="nonbreaking-interword-space"> </span> 3) поддерживаемые алгоритмы шифрования, кода аутентификации сообщений, хеширования, ЭП и сжатия.</li></ol></li><li><span class="mathjax">$C \leftarrow S$</span>:
        <ol><li>ServerHello: одноразовая метка <span class="mathjax">$N_S$</span>, поддерживаемые сервером алгоритмы.

            После обмена набором желательных алгоритмов сервер и клиент по единому правилу выбирают общий набор алгоритмов.</li><li>Server Certificate: сертификат X.509v3 сервера с запрошенным URI (URI нужен в случае нескольких виртуальных веб-серверов с разными URI на одном узле c одним IP-адресом).</li><li>Server Key Exchange Message: информация для создания предварительного общего секрета <span class="mathjax">$premaster$</span> длиной 48 байтов в виде: <span class="nonbreaking-interword-space"> </span> 1) обмена по протоколу Диффи<span class="nonbreaking-interword-space"> </span>&mdash;<span class="nonbreaking-interword-space"> </span>Хеллмана<a name="N107057"><!--протокол!Диффи—Хеллмана--></a> с клиентом (сервер отсылает <span class="mathjax">$(g, g^a)$</span>), <span class="nonbreaking-interword-space"> </span> 2)Обмена по другому алгоритму с открытым ключом, <span class="nonbreaking-interword-space"> </span> 3) разрешения клиенту выбрать ключ.</li><li>Электронная подпись к Server Key Exchange Message на ключе сертификата сервера для аутентификации сервера клиенту.</li><li>Certificate Request: опциональный запрос сервером сертификата клиента.</li><li>Server Hello Done: идентификатор конца транзакции.</li></ol></li><li><span class="mathjax">$C \rightarrow S$</span>:
        <ol><li>Client Certificate: сертификат X.509v3 клиента, если он был запрошен сервером.</li><li>Client Key Exchange Message: информация для создания предварительного общего секрета <span class="mathjax">$premaster$</span> длиной 48 байтов в виде: <span class="nonbreaking-interword-space"> </span> 1) либо обмена по протоколу Диффи<span class="nonbreaking-interword-space"> </span>&mdash;<span class="nonbreaking-interword-space"> </span>Хеллмана<a name="N107098"><!--протокол!Диффи—Хеллмана--></a> с сервером (клиент отсылает <span class="mathjax">$g^b$</span>, в результате обе стороны вычисляют ключ <span class="mathjax">$premaster = g^{ab}$</span>), <span class="nonbreaking-interword-space"> </span> 2) либо обмена по другому алгоритму, <span class="nonbreaking-interword-space"> </span> 3) либо ключа, выбранного клиентом и зашифрованного на открытом ключе из сертификата сервера.</li><li>Электронная подпись к Client Key Exchange Message на ключе сертификата клиента для аутентификации клиента серверу (если клиент использует сертификат).</li><li>Certificate Verify: результат проверки сертификата сервера.</li><li>Change Cipher Spec: уведомление о смене сеансовых ключей.</li><li>Finished: идентификатор конца транзакции.</li></ol></li><li><span class="mathjax">$C \leftarrow S$</span>:
        <ol><li>Change Cipher Spec: уведомление о смене сеансовых ключей.</li><li>Finished: идентификатор конца транзакции.</li></ol></li></ol><!--%      http://tools.ietf.org/html/rfc5246#page-37--><!--%      struct {--><!--%          ProtocolVersion client_version;--><!--%          Random random;--><!--%          SessionID session_id;--><!--%          CipherSuite cipher_suites<2..2^16-2>;--><!--%          CompressionMethod compression_methods<1..2^8-1>;--><!--%          select (extensions_present) {--><!--%              case false:--><!--%                  struct {};--><!--%              case true:--><!--%                  Extension extensions<0..2^16-1>;--><!--%          };--><!--%      } ClientHello;--><!--%      struct {--><!--%          ProtocolVersion server_version;--><!--%          Random random;--><!--%          SessionID session_id;--><!--%          CipherSuite cipher_suite;--><!--%          CompressionMethod compression_method;--><!--%          select (extensions_present) {--><!--%              case false:--><!--%                  struct {};--><!--%              case true:--><!--%                  Extension extensions<0..2^16-1>;--><!--%          };--><!--%      } ServerHello;--><!--%      struct {--><!--%          ASN.1Cert certificate_list<0..2^24-1>;--><!--%      } Certificate;--><!--%      struct {--><!--%          select (KeyExchangeAlgorithm) {--><!--%              case dh_anon:--><!--%                  ServerDHParams params;--><!--%              case dhe_dss:--><!--%              case dhe_rsa:--><!--%                  ServerDHParams params;--><!--%                  digitally-signed struct {--><!--%                      opaque client_random[32];--><!--%                      opaque server_random[32];--><!--%                      ServerDHParams params;--><!--%                  } signed_params;--><!--%              case rsa:--><!--%              case dh_dss:--><!--%              case dh_rsa:--><!--%                  struct {} ;--><!--%                 /* message is omitted for rsa, dh_dss, and dh_rsa */--><!--%              /* may be extended, e.g., for ECDH - - see [TLSECC] */--><!--%          };--><!--%      } ServerKeyExchange;--><!--%      struct {--><!--%          ClientCertificateType certificate_types<1..2^8-1>;--><!--%          SignatureAndHashAlgorithm--><!--%            supported_signature_algorithms<2^16-1>;--><!--%          DistinguishedName certificate_authorities<0..2^16-1>;--><!--%      } CertificateRequest;--><!--%      struct {--><!--%          select (KeyExchangeAlgorithm) {--><!--%              case rsa:--><!--%                  EncryptedPreMasterSecret;--><!--%              case dhe_dss:--><!--%              case dhe_rsa:--><!--%              case dh_dss:--><!--%              case dh_rsa:--><!--%              case dh_anon:--><!--%                  ClientDiffieHellmanPublic;--><!--%          } exchange_keys;--><!--%      } ClientKeyExchange;--><!--%      struct {--><!--%           digitally-signed struct {--><!--%               opaque handshake_messages[handshake_messages_length];--><!--%           }--><!--%      } CertificateVerify;--><!--%      struct {--><!--%          opaque verify_data[verify_data_length];--><!--%      } Finished;--><p>Одноразовая метка <span class="mathjax">$N_C$</span> состоит из 32 байтов. Первые 4 байта содержат текущее время (gmt</p><_></_><p>unix</p><_></_><p>time), оставшиеся байты &ndash; псевдослучайную последовательность, которую формирует криптографически стойкий генератор псевдослучайных чисел.</p><p>Предварительный общий секрет <span class="mathjax">$premaster$</span> длиной 48 байтов вместе с одноразовыми метками используется как инициализирующее значение генератора <span class="mathjax">$PRF$</span> для получения общего секрета <span class="mathjax">$master$</span>, тоже длиной 48 байтов:</p><div class="mathjax" style="text-align: center;">$$ master = PRF(premaster, ~\text{текст \textquotedblleft master secret\textquotedblright}, ~ N_C + N_S) .$$</div><p>И, наконец, уже из секрета <span class="mathjax">$master$</span> таким же способом генерируется 6 окончательных сеансовых ключей, следующих друг за другом в битовой строке:</p><div class="mathjax" style="text-align: center;">$$ \{ (K_{E,1} ~\|~ K_{E,2}) ~\|~ (K_{{\textrm{MAC}},1} ~\|~ K_{{\textrm{MAC}},2}) ~\|~ (IV_1 ~\|~ IV_2) \} = $$</div><div class="mathjax" style="text-align: center;">$$ = PRF(master, ~\text{текст \textquotedblleft key expansion\textquotedblright}, ~ N_C + N_S), $$</div><p>где <span class="mathjax">$K_{E,1}$</span>, <span class="mathjax">$K_{E,2}$</span> &ndash; два ключа симметричного шифрования, <span class="mathjax">$K_{{\textrm{MAC}},1}$</span>, <span class="mathjax">$K_{{\textrm{MAC}},2}$</span> &ndash; два ключа имитовставки<a name="N107261"><!--имитовставка--></a>, <span class="mathjax">$IV_1$</span>, <span class="mathjax">$IV_2$</span> &ndash; два инициализирующих вектора режима сцепления блоков<a name="N107273"><!--вектор инициализации--></a>. Ключи с индексом 1 используются для коммуникации от клиента к серверу, с индексом 2 &ndash; от сервера к клиенту.</p><h3 data-command-name="subsection" id="13_3_2_Протокол_записи">13.3.2. Протокол записи</h3><p>Протокол записи (англ. <span lang="en"><i>Record Protocol</i></span>) определяет формат TLS-пакетов для вложения в TCP-пакеты.</p><ol><li>Исходными сообщениями <span class="mathjax">$M$</span> для шифрования являются пакеты протокола следующего уровня в модели OSI: HTTP<a name="N107309"><!--протокол!HTTP--></a>, FTP<a name="N107315"><!--протокол!FTP--></a>, IMAP<a name="N107321"><!--протокол!IMAP--></a> и<span class="nonbreaking-interword-space"> </span>т.&nbsp;д.</li><li>Сообщение <span class="mathjax">$M$</span> разбивается на блоки <span class="mathjax">$m_i$</span> размером не более 16 кибибайт.</li><li>Блоки <span class="mathjax">$m_i$</span> сжимаются алгоритмом компрессии в блоки <span class="mathjax">$z_i$</span>.</li><li>Вычисляется имитовставка<a name="N107349"><!--имитовставка--></a> для каждого блока <span class="mathjax">$z_i$</span> и добавляется в конец блоков: <span class="mathjax">$a_i = z_i ~\|~ {\textrm{HMAC}}(K_{{\textrm{MAC}}}, z_i)$</span>.</li><li>Блоки <span class="mathjax">$a_i$</span> шифруются симметричным алгоритмом с ключом <span class="mathjax">$K_E$</span> в некотором режиме сцепления блоков с инициализирующим вектором <span class="mathjax">$IV$</span> в полное сжатое аутентифицированное зашифрованное сообщение <span class="mathjax">$C$</span>.</li><li>К шифртексту <span class="mathjax">$C$</span> добавляется заголовок протокола записи TLS, в результате чего получается TLS-пакет для вложения в TCP-пакет.</li></ol><nav aria-label="Page navigation example"><ul class="pagination justify-content-center"><li class="page-item"><a class="page-link" href="13_2_Pretty_Good_Privacy.html">&#129080; 13_2_Pretty_Good_Privacy</a></li><li class="page-item"><a class="page-link" href="13_4_Zaschita_IPsec_na_setevom_urovne.html">13_4_Zaschita_IPsec_na_setevom_urovne &#129082;</a></li></ul></nav></div><script>
window.MathJax = {
  loader: {
    load: ['[tex]/tagformat'],
  },
  options: {
    processHtmlClass: 'mathjax'
  },
  tex: {
    packages: {
      '[+]': ['base', 'ams', 'physics', 'textcomp']
    },
    inlineMath: [['$', '$']],
  },
};
</script><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script async="yes" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script></body></html>