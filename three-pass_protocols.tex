\section{Трёхпроходные протоколы}
\selectlanguage{russian}

Если между Алисой и Бобом существует канал связи, недоступный для модификации злоумышленником (то есть когда применима модель только пассивного криптоаналитика), то даже без предварительного обмена секретными ключами или другой информацией можно воспользоваться идеями, использованными ранее в криптографии на открытых ключах. После описания RSA в 1978 году, в 1980 Ади Шамир предложил использовать криптосистемы, основанные на коммутативных операциях, для передачи информации без предварительного обмена секретными ключами. Если предположить, что передаваемой информацией является выработанной одной из сторон секретный сеансовый ключ, то в общем виде мы получаем следующий трёхпроходной протокол.

Предварительно:

\begin{itemize}
	\item Стороны $A$ и $B$ соединены незащищённым каналом связи.
	\item Каждая из сторон имеет пару из открытого и закрытого ключей $K_A$, $k_A$, $K_B$, $k_B$ соответственно.
	\item Сторонами выбрана и используется коммутативная функция шифрования:
	\begin{align*}
		D_{A} \left( E_{A} \left( m \right) \right)	&= m		& ~~\forall ~ m, \left\{ K_A, k_a \right\}; \\
		E_{A} \left( E_{B} \left( m \right) \right)	&= E_B \left( E_A \left( m \right) \right) & ~~\forall ~ K_A, K_B, m.
	\end{align*}
\end{itemize}

Протокол состоит из трёх шагов (отсюда и название).
\begin{enumerate}
    \item Алиса создаёт новый секретный сеансовый ключ $K_S$, шифрует его с помощью своего ключа $K_A$ и посылает сообщение Бобу:
        \[ A \rightarrow B: ~ E_A \left( K_S \right). \]
    \item Боб получает это сообщение, шифрует его с помощью своего ключа $K_B$ и посылает сообщение Алисе:
        \[ A \leftarrow B: ~ E_B \left( E_A \left( K_S \right) \right). \]
    Алиса, получив сообщение $E_B \left( E_A \left( K_S \right) \right)$, использует свой закрытый ключ $k_A$ для расшифрования:
            \[ D_A \left( E_B \left( E_A \left( K_S \right) \right) \right) = E_B \left( K_S \right). \]
    \item Алиса передаёт Бобу сообщение, в котором новый секретный сеансовый ключ зашифрован уже только ключом Боба:
        \[ A \rightarrow B: ~ E_B \left( K_S \right). \]
    Боб, получив сообщение $E_B \left( K_S \right)$, использует свой ключ $k_B$ для расшифрования:
            \[ D_B \left( E_B \left( K_S \right) \right) = K_S. \]
\end{enumerate}

В результате стороны получают общий секретный ключ $K_S$.

Общим недостатком всех подобных протоколов является отсутствие аутентификации сторон. Конечно, в случае пассивного криптоаналитика это не требуется, но в реальной жизни всё-таки нужно рассматривать все возможные модели (в том числе активного криптоаналитика) и использовать такие протоколы, которые предполагают взаимную аутентификацию сторон.

\subsection[Тривиальный случай]{Тривиальный случай}

Приведём пример протокола на основе такой <<неудачно>> с точки зрения безопасности функции, как XOR.

\begin{enumerate}
    \item $A$ имеет функцию шифрования совершенной секретности $E_{K_A}(K) = K \oplus K_A$, где $K_A$ -- двоичная последовательность с равномерным распределением символов. $A$ посылает это сообщение стороне $B$:
            \[ A \rightarrow B: ~ E_{K_A}(K) = K \oplus K_A. \]
    \item $B$ использует такую же функцию шифрования совершенной секретности с ключом $K_B$ (двоичная последовательность с равномерным распределением символов). $B$ шифрует полученное сообщение и отправляет это сообщение $A$:
            \[ A \leftarrow B: ~ E_{K_A}(K) \oplus K_B = K \oplus K_A \oplus K_B. \]
    \item Сторона $A$, получив сообщение $K \oplus K_A \oplus K_B$, выполняет расшифрование:
            \[ K \oplus K_A \oplus K_B \oplus K_A = K \oplus K_B. \]
        Сторона $A$ передаёт стороне $B$ сообщение:
            \[ A \rightarrow B: ~ K \oplus K_B. \]
    \item Сторона $B$, получив сообщение $K \oplus K_B$, выполняет расшифрование:
            \[ K \oplus K_B \oplus K_B = K. \]
        Обе стороны получают общий секретный ключ $K$.
\end{enumerate}

Предложенный выбор коммутативной функции шифрования совершенной секретности был назван неудачным, так как существуют ситуации, при которых криптоаналитик может определить ключ $K$. Предположим, что криптоаналитик перехватил все три сообщения:
    \[ K \oplus K_A, ~~ K \oplus K_A \oplus K_B, ~~ K \oplus K_B. \]
Сложение по модулю 2 всех трёх сообщений даёт ключ $K$. Поэтому такая система шифрования не применяется.

Теперь приведём протокол надёжной передачи секретного ключа, основанный на экспоненциальной (коммутативной) функции шифрования. Стойкость этого протокола связана с трудностью задачи вычисления дискретного логарифма: известны значения $y, g, p$, найти $x$ в уравнении $y = g^x \mod p$.

\subsection{Безключевой протокол Шамира}\index{протокол!Шамира бесключевой|(}

Стороны предварительно договариваются о большом простом числе $p \sim 2^{1024}$.

\begin{enumerate}
    \item Сторона $A$ задаёт общий секретный ключ $K_S < p$ и выбирает целое число $a$, взаимно простое с $p-1$. $A$ вычисляет и посылает сообщение стороне $B$:
            \[ A \rightarrow B: ~ K^a \mod p. \]
        Существует число $c$ такое, что $a c =1 \mod (p-1)$, то есть $a c = 1 + l (p-1)$, где $l$ -- целое число. Число $c$ будет использовано стороной $A$ на следующем этапе.
    \item Сторона $B$ выбирает целое число $b$, взаимно простое с $p-1$. Используя полученное сообщение, $B$ вычисляет и посылает сообщение стороне $A$:
            \[ A \leftarrow B: ~ (K_S^a)^b \mod p. \]
    \item Сторона $A$, получив сообщение, вычисляет
        \[ \left( K_S^{ab} \right)^c = K^{(1 + l (p-1)) b} = K_S^b \cdot K^{l (p-1) b} = K_S^b \mod p. \]
        Здесь применена малая теорема Ферма\index{теорема!Ферма малая}: $K^{p-1} = 1 \mod p$, поэтому $\left( K_S^{p-1} \right)^{lb} = 1 \mod p$.
        $A$ посылает $B$ сообщение:
            \[ A \rightarrow B: ~ K^b \mod p. \]
    \item Сторона $B$, получив сообщение $K^{b}\mod p$, вычисляет
        \[ (K_S^b \mod p)^d = K_S^{bd} \mod p = K_S, \]
        где $d$ найдено из $b d =1 \mod (p-1)$.
\end{enumerate}

Теперь проверим криптостойкость этого протокола. Предположим, что криптоаналитик перехватил три сообщения:
\[ \begin{array}{l}
    y_1 = K_S^a \mod p, \\
    y_2 = K_S^{ab} \mod p, \\
    y_3 = K_S^b \mod p. \\
\end{array} \]

Чтобы найти ключ $K_S$, надо решить систему из этих трёх уравнений, что имеет очень большую вычислительную сложность, неприемлемую с практической точки зрения, если все три числа $a, b, ab$ достаточно велики. Предположим, что $a$ (или $b$) мало. Тогда, вычисляя последовательные степени $y_3$ (или $y_1$), можно найти $a$ (или $b$), сравнивая результат с $y_2$. Зная $a$, легко найти $a^{-1}\mod(p-1)$ и $K=(y_1)^{a^{-1}}\mod p$.

\index{протокол!Шамира бесключевой|)}
